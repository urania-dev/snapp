<script lang="ts">
	import { applyAction, enhance } from '$app/forms';
	import { invalidateAll } from '$app/navigation';
	import { toast } from 'svelte-sonner';
	import Card from '$lib/ui/card.svelte';
	import { cn } from '$lib/utils/cn';
	import Icon from '$lib/ui/icon.svelte';
	import Input from '$lib/ui/input.svelte';
	import Switch from '$lib/ui/switch.svelte';
	import type { SubmitFunction } from '@sveltejs/kit';
	import { intlFormatDistance } from 'date-fns';
	import { _ } from 'svelte-i18n';
	import QRCode from 'qrcode';
	import type { MouseEventHandler } from 'svelte/elements';
	import { fade, fly } from 'svelte/transition';
	import Chart from '$lib/ui/chart.svelte';
	import { browser } from '$app/environment';
	import { outside } from '$lib/utils/outside';
	import { queryParameters } from 'sveltekit-search-params';
	import { debounce } from '$lib/utils/debounce';
	import { page } from '$app/state';

	let { data, form } = $props();
	let active = $state(!data.snapp.disabled);

	const handle_disable: MouseEventHandler<HTMLElement> = (e) => {
		e.stopPropagation();
		e.preventDefault();
		active = !active;
		document.forms.namedItem('disable-snapp')?.requestSubmit();
	};

	const enhanceAction: SubmitFunction = ({ formData }) => {
		formData.set('disabled', String(!active));

		return async function ({ result }) {
			await applyAction(result);
			await invalidateAll();
			if (form?.message) toast.info($_(form.message));
		};
	};

	function getRelativeDate(date: Date) {
		const rel = intlFormatDistance(date, new Date(), { locale: data.lang });
		return rel;
	}

	let show_tab = $state<'details' | 'notes' | 'tags'>('tags');

	const get_dates = () => {
		let dataset: number[] = [];
		let labels: string[] = [];

		const days = Math.abs(
			Math.floor((data.end.getTime() - data.start.getTime()) / 1000 / 60 / 60 / 24)
		);

		const date = new Date(data.start);

		for (let i = 0; i <= days; i++) {
			const dateString = date.toISOString().split('T')[0];

			if (dateString in data.metrics) {
				dataset.push(data.metrics[dateString]);
			} else {
				dataset.push(0);
			}
			labels.push(dateString);

			date.setDate(date.getDate() + 1);
		}
		return {
			dataset,
			labels
		};
	};
	const chartData = $derived(get_dates());

	let secure_context = $derived(browser && navigator.clipboard && page.url.protocol === 'https:');

	const handle_copy_snapp_to_clipboard: MouseEventHandler<HTMLButtonElement> = async function (e) {
		e.stopPropagation();
		e.preventDefault();
		const idx = e.currentTarget.dataset.idx;
		if (!secure_context) {
			toast.error($_('tokens.not-allowed-to-copy'));
			return;
		}

		if (idx && navigator.clipboard) await navigator.clipboard.writeText(fullUrlToSnapp);
		toast.info($_('snapps.helpers.copied-to-clipboard'));
	};

	let show_zoomed_qrcode = $state(false);
	let handle_show_zoomed_qrcode: MouseEventHandler<HTMLButtonElement> = (e) => {
		e.preventDefault();
		e.stopPropagation();
		show_zoomed_qrcode = !show_zoomed_qrcode;
	};

	let fullUrlToSnapp = $derived(
		page.url.origin + '/' + data.tagsAsPrefix
			? data.snapp.tags[0]?.name + '/' + data.snapp.shortcode
			: data.snapp.shortcode
	);

	let can_share = $derived(browser === true && window?.navigator?.share);
	let tagToAdd = $state<string>();
	let tagAction = $state<string>();
	const handle_tag: MouseEventHandler<HTMLButtonElement> = (e) => {
		const idx = e.currentTarget.dataset.idx;
		const action = e.currentTarget.dataset.action;
		if (idx) {
			tagToAdd = idx;
			tagAction = action;
			document.forms.namedItem('handle-tag')?.requestSubmit();
		}
	};

	const enhanceTagAction: SubmitFunction = ({ formData }) => {
		if (tagToAdd) formData.set('id', tagToAdd);
		if (tagAction) formData.set('action', tagAction);

		return async ({ result }) => {
			await applyAction(result);
			await invalidateAll();
			if (form?.message) toast.info($_(form.message));
		};
	};

	const params = queryParameters({
		query: true,
		limit: {
			defaultValue: data.limit as number | undefined,
			decode: (val: string | null) => (val ? parseInt(val) : null),
			encode: (val: number) => val.toString()
		},
		page: {
			defaultValue: 1,
			encode: (number) => number.toString(),
			decode: (stringedNumber) => (stringedNumber && parseInt(stringedNumber)) || null
		}
	});

	const max_pages = $derived(Math.ceil(data.countTag / (params.limit || data.limit)));
	const enhanceRows: SubmitFunction = ({ formData }) => {
		formData.set('rows', limitValue.toString());
		return async ({ result }) => {
			await applyAction(result);
			await invalidateAll();
			if (form?.message) toast.info($_(form.message));
			params.limit = limitValue;
		};
	};
	let limitValue = $state<number>(data.limit);
</script>

<form action="?/disable" id="disable-snapp" hidden method="post" use:enhance={enhanceAction}></form>

{#if show_zoomed_qrcode === true}
	<div id="zoomed" class="fixed inset-0 z-[100] flex flex-col bg-neutral-950/50" transition:fade>
		<div
			use:outside={() => {
				show_zoomed_qrcode = false;
			}}
			class="z-30 m-auto flex rounded w-full max-w-sm flex-col gap-4 overflow-y-scroll text-balance border border-slate-500/50 bg-neutral-50 p-4 leading-relaxed text-neutral-950 transition-colors dark:bg-neutral-950 dark:text-neutral-50"
			transition:fly={{ y: 25 }}
		>
			{#await QRCode.toDataURL(fullUrlToSnapp, { width: 350, margin: 2 })}
				<Icon ph="spinner" />
			{:then generated}
				<div class="flex gap-4 flex-col">
					<Card css={{ card: 'p-2' }}>
						<img
							src={generated}
							class="w-full h-full aspect-square"
							alt="QRCode: {data.snapp.shortcode}"
						/>
					</Card>
					<Card css={{ card: 'items-center text-balance w-full leading-relaxed gap-4 p-2' }}>
						<div class="flex flex-col md:flex-row w-full h-full gap-4">
							<div class="flex w-full h-full gap-2 flex-col items-center justify-center">
								<span class="w-full text-sm font-bold">QR Code</span>
								<div class="flex gap-4 flex-col justify-center w-full">
									<button
										onclick={async () => {
											const a = document.createElement('a');
											a.href = await QRCode.toDataURL(fullUrlToSnapp, {
												width: 800,
												margin: 4
											});
											a.title = 'QRCode: [' + data.snapp.shortcode + ']';
											a.download = 'qrcode-' + data.snapp.shortcode + '.png';
											a.click();
										}}
										class="flex h-10 flex-row w-full items-center gap-2 rounded border-none bg-slate-500/25 p-0 px-4 text-start font-semibold outline-none transition-all hover:bg-slate-500/85 focus:bg-slate-500/85 md:h-8"
										><Icon ph="download" />
										<small class="text-sm">{$_('globals.download')}</small></button
									>
									{#if can_share}
										<button
											onclick={async () => {
												const filename = data.snapp.shortcode + '.png';
												const dataUri = await QRCode.toDataURL(fullUrlToSnapp);
												function dataUriToBlob(dataURI: string, dataTYPE: string) {
													var binary = atob(dataURI.split(',')[1]),
														array = [];
													for (var i = 0; i < binary.length; i++) array.push(binary.charCodeAt(i));
													return new Blob([new Uint8Array(array)], { type: dataTYPE });
												}

												const _data = {
													files: [
														new File([dataUriToBlob(dataUri, 'image/png')], filename, {
															type: 'image/png'
														})
													],
													title: filename,
													text: fullUrlToSnapp
												};
												try {
													if (!navigator.canShare(_data)) return;

													await navigator.share(_data);
												} catch (err) {
													console.log(err);
												}
											}}
											class="flex h-10 flex-row w-full max-w-none items-center gap-2 rounded border-none bg-slate-500/25 p-0 px-4 text-start font-semibold outline-none transition-all hover:bg-slate-500/85 focus:bg-slate-500/85 md:h-8"
											><Icon ph="share-network" />
											<small class="text-sm">{$_('globals.share')}</small></button
										>{/if}
								</div>
							</div>
						</div>
					</Card>
				</div>
			{/await}
		</div>
	</div>
{/if}
<div class={cn('flex w-full flex-col grow p-4', show_tab === 'notes' ? 'h-full' : '')}>
	<div class="mx-auto flex h-full w-full max-w-5xl flex-col gap-4">
		<a class="flex gap-2 font-semibold uppercase tracking-wider" href="/dashboard"
			><Icon ph="arrow-left" /><small class="text-sm">{$_('globals.back')}</small></a
		>
		<div class="flex w-full flex-col justify-between gap-4 lg:flex-row lg:items-center">
			<div class="flex w-full leading-none items-center gap-2">
				<Icon ph="link-simple" size={36} />

				{#if data.tagsAsPrefix}
					<h2 class="text-lg font-bold">{data.snapp.tags?.[0]?.slug || 'no-path'}</h2>
					<span class="flex"><Icon ph="circle" style="fill" size={8} /></span>
					<h2 class="text-lg font-bold">{data.snapp.shortcode}</h2>
				{:else}
					<h2 class="text-lg font-bold">
						{data.snapp.shortcode}
					</h2>
				{/if}
			</div>
			<div class="flex w-full flex-col gap-4 lg:max-w-max lg:flex-row">
				{#if secure_context}
					<button
						data-idx={data.snapp.shortcode}
						onclick={handle_copy_snapp_to_clipboard}
						class="flex h-10 flex-row items-center justify-between gap-2 rounded border-none bg-slate-500/25 p-0 px-4 text-start font-semibold outline-none transition-all hover:bg-slate-500/85 focus:bg-slate-500/85 md:h-8"
					>
						<small class="text-sm">{$_('globals.copy')}</small>
						<Icon ph="copy"></Icon>
					</button>
				{/if}
				<Card css={{ card: 'lg:h-8 h-10 items-center lg:max-w-max gap-4 p-0' }}>
					<a
						class="flex w-full items-center justify-between gap-4 p-2 px-4 hover:text-pink-500 lg:p-1 lg:px-4"
						href="/{data.tagsAsPrefix
							? data.snapp.tags?.[0]?.slug + '/' + data.snapp.shortcode
							: data.snapp.shortcode}"
						target="_blank"
						data-sveltekit-preload-data={false}
					>
						<small class="pt-0.5 text-sm font-medium">
							{$_('snapps.labels.open-link')}
						</small>
						<Icon ph="arrow-square-out"></Icon>
					</a>
				</Card>
			</div>
		</div>
		{#key [data.start, data.end]}
			<Card css={{ card: 'flex-row w-full' }}>
				<Chart
					label={$_('snapps.fields.hit')}
					total_count={data.totalVisits}
					css={{ container: 'h-64' }}
					data={chartData}
					start={data.start}
					end={data.end}
				></Chart>
			</Card>
		{/key}
		<Card css={{ card: 'flex-row w-full h-16 md:h-14 shrink-0 overflow-x-scroll p-2' }}>
			<button
				onclick={() => (show_tab = 'details')}
				class={cn(
					'flex h-10 w-full  max-w-max min-w-max items-center gap-2 rounded p-2 text-sm leading-none transition-all hover:bg-slate-500/85 focus:bg-slate-500/85 md:h-8',
					show_tab === 'details' ? 'bg-slate-500/85' : 'bg-slate-500/25 '
				)}>{$_('snapps.labels.details')}</button
			>
			<button
				onclick={() => (show_tab = 'notes')}
				class={cn(
					'flex h-10 w-full max-w-max min-w-max items-center gap-2 rounded p-2 text-sm leading-none transition-all hover:bg-slate-500/85 focus:bg-slate-500/85 md:h-8',
					show_tab === 'notes' ? 'bg-slate-500/85' : 'bg-slate-500/25 '
				)}>{$_('snapps.fields.notes')}</button
			>
			<button
				class={cn(
					'flex h-10 w-full max-w-max min-w-max items-center gap-2 rounded p-2 text-sm bg-slate-500/25 leading-none transition-all hover:bg-slate-500/85 focus:bg-slate-500/85 md:h-8'
				)}
				onclick={handle_show_zoomed_qrcode}>QR Code</button
			>
			<button
				class={cn(
					'flex h-10 w-full max-w-max min-w-max items-center gap-2 rounded p-2 text-sm bg-slate-500/25 leading-none transition-all hover:bg-slate-500/85 focus:bg-slate-500/85 md:h-8',
					show_tab === 'tags' ? 'bg-slate-500/85' : 'bg-slate-500/25 '
				)}
				onclick={() => (show_tab = 'tags')}>{$_('menu.tags')}</button
			>
			<a
				href="/dashboard/{data.snapp.id}/edit"
				class={cn(
					'flex h-10 w-full max-w-max min-w-max items-center gap-2 rounded p-2 text-sm leading-none transition-all hover:bg-slate-500/85 focus:bg-slate-500/85 md:h-8',
					show_tab === 'notes' ? 'bg-slate-500/85' : 'bg-slate-500/25 '
				)}
				>{$_('snapps.labels.edit')}
			</a>
		</Card>
		{#if show_tab === 'details'}
			<div class="flex w-full" in:fly={{ y: 25 }}>
				<Card css={{ card: 'gap-4 w-full' }}>
					<div class="flex w-full flex-col gap-4 lg:flex-row">
						<Card
							css={{
								card: 'items-center text-balance max-w-lg w-full leading-relaxed gap-4 p-2'
							}}
						>
							<Switch
								name="status"
								label="{$_('snapps.fields.status')}: {active === true
									? $_('globals.active')
									: $_('globals.disabled')}"
								helper={$_('snapps.helpers.disable-text-1')}
								actions={{ toggle: handle_disable }}
								bind:value={active}
							></Switch>
							<small class="w-full">{$_('snapps.helpers.disable-text-2')}</small>
						</Card>
						<div class="flex w-full flex-col gap-4">
							<Card css={{ card: 'p-2 gap-4' }}>
								<Input
									icons={{ left: 'globe' }}
									name="original_url"
									disabled
									label={$_('snapps.fields.original-url')}
									value={data.snapp.original_url}
								/>
							</Card>
							<Card css={{ card: 'p-2 gap-4 max-w-none w-full' }}>
								<Input
									icons={{ left: 'link-simple-horizontal' }}
									name="shortcode"
									disabled
									label={$_('snapps.fields.shortcode')}
									value={data.snapp.shortcode}
								/>
							</Card>
						</div>
					</div>
					<div class="flex w-full flex-col gap-4 lg:flex-row">
						<Card
							css={{ card: 'items-center text-balance w-full leading-relaxed gap-4 p-2 h-full' }}
						>
							<Input
								icons={{ left: 'lock-laminated' }}
								css={{ 'icon-left': data.snapp.secret === null ? 'opacity-25' : 'opacity-100' }}
								name="secret"
								disabled
								label={$_('snapps.fields.secret')}
								value={data.snapp.secret === null
									? $_('snapps.helpers.not-secret')
									: $_('snapps.helpers.secret')}
							/>
						</Card>
						<Card css={{ card: 'p-2 gap-4 flex-row w-full' }}>
							<Input
								name="hit"
								disabled
								label={$_('snapps.fields.hit')}
								css={{ input: 'capitalize' }}
								value={data.snapp.hit}
							/>
							<Input
								name="used"
								disabled
								label={$_('snapps.fields.used')}
								css={{
									input: cn(
										'capitalize',
										data.snapp.max_usages > 0
											? ''
											: 'text-xxs tracking-wider text-center opacity-50 uppercase font-semibold'
									)
								}}
								value={data.snapp.max_usages && data.snapp.max_usages > 0
									? data.snapp.used
									: $_('snapps.helpers.not-max-usages')}
							/>
							<Input
								name="max-usages"
								disabled
								label={$_('snapps.fields.max-usages')}
								css={{
									input: cn(
										'capitalize',
										data.snapp.max_usages > 0
											? ''
											: 'text-xxs tracking-wider text-center opacity-50 uppercase font-semibold'
									)
								}}
								value={data.snapp.max_usages > 0
									? data.snapp.max_usages
									: $_('snapps.helpers.not-max-usages')}
							/>
						</Card>
					</div>
					<div class="flex w-full flex-col gap-4 lg:flex-row">
						<Card css={{ card: 'p-2 gap-4' }}>
							<Input
								icons={{ left: 'clock' }}
								name="created"
								disabled
								label={$_('snapps.fields.created')}
								css={{ input: 'capitalize' }}
								value={getRelativeDate(data.snapp.created)}
							/>
						</Card>
						<Card css={{ card: 'p-2 gap-4 flex-row w-full' }}>
							<Input
								icons={{ left: 'alarm' }}
								name="expiration"
								disabled
								label={$_('snapps.fields.expiration')}
								css={{
									input: cn(
										'capitalize',
										data.snapp.expiration === null
											? 'opacity-50 text-xxs text-center font-semibold uppercase tracking-wider'
											: ''
									)
								}}
								value={data.snapp.expiration
									? getRelativeDate(data.snapp.expiration)
									: $_('globals.disabled')}
							/>
						</Card>
					</div>
				</Card>
			</div>
		{/if}
		{#if show_tab === 'notes'}
			<div class="flex h-full w-full" in:fly={{ y: 25 }}>
				<Card css={{ card: 'flex-row h-full' }}>
					<Input
						label={$_('snapps.fields.notes')}
						type="textarea"
						name="notes"
						css={{ field: 'h-full', input: 'text-balance' }}
						disabled
						value={data.snapp.notes}
					/>
				</Card>
			</div>
		{/if}

		{#if show_tab === 'tags'}
			<div class="flex h-full grow w-full" in:fly={{ y: 25 }}>
				<Card css={{ card: 'flex w-full h-full' }}>
					<div class="flex h-full flex-col w-full gap-4 overflow-y-scroll">
						<Card css={{ card: 'p-2 gap-4 flex h-full' }}>
							{#each data.tags as tag}
								<Card css={{ card: 'h-10 p-0 px-4 items-center flex-row' }}>
									<div class="flex gap-4 items-center">
										<form
											hidden
											id="handle-tag"
											method="post"
											action="?/handle-tag"
											use:enhance={enhanceTagAction}
										></form>
										<button
											data-action={data.snapp.tags.map((t) => t.slug).includes(tag.slug)
												? 'disconnect'
												: 'connect'}
											data-idx={tag.slug}
											class="flex items-center w-max p-0 h-max"
											onclick={handle_tag}
										>
											{#if data.snapp.tags.map((t) => t.slug).includes(tag.slug)}
												<Icon ph="tag-simple" style="fill" />
											{:else}
												<Icon ph="tag-simple" />
											{/if}
										</button>
										<small class="text-sm">{tag.name}</small>
									</div>
									<div class="flex gap-8 items-center ms-auto">
										<div class="flex gap-2 md:gap-4 items-center">
											<span class="md:min-w-[6ch] text-end">{tag._count.users}</span>
											<Icon ph="users-three" />
										</div>
										<div class="flex gap-2 md:gap-4 items-center">
											<span class="md:min-w-[6ch] text-end">{tag._count.snapps}</span>
											<Icon ph="link-simple" />
										</div>
									</div>
								</Card>
							{/each}
							{#each { length: Math.max(0, (params.limit || 0) - data.tags.length) }}
								<Card css={{ card: 'h-10 p-0 px-4 items-center flex-row' }}></Card>
							{/each}
						</Card>
						<div class="mt-auto flex w-full flex-col gap-2 md:flex-row">
							<Card css={{ card: 'w-full p-2 h-full md:flex-row justify-between' }}>
								<div class="flex w-full gap-2">
									<form
										method="post"
										action="?/save-rows"
										use:enhance={enhanceRows}
										id="save-rows"
										hidden
									></form>
									<Input
										name="limit"
										icons={{ left: 'rows' }}
										actions={{
											change: () => {
												document.forms.namedItem('save-rows')?.requestSubmit();
											},
											input: () => {
												debounce(
													() => document.forms.namedItem('save-rows')?.requestSubmit(),
													1000
												)();
											}
										}}
										css={{
											field: 'max-h-10 md:max-h-8 p-0 flex-row max-w-max',
											input: 'text-sm max-h-10 md:max-h-8 w-full text-center',
											group: 'max-h-10 min-h-10 md:max-h-8 md:min-h-8 w-20',
											label: 'hidden'
										}}
										bind:value={limitValue}
									/>
									<Input
										name="search"
										placeholder={$_('tags.placeholders.search')}
										css={{
											field: 'max-h-10 md:max-h-8 p-0 flex-row md:max-w-[19rem]',
											input: 'text-sm max-h-10 md:max-h-8',
											group: 'max-h-10 min-h-10 md:max-h-8 md:min-h-8',
											label: 'hidden'
										}}
										icons={{ left: 'magnifying-glass' }}
										bind:value={params.query}
									/>
								</div>
								<div
									class="flex w-full items-center justify-start gap-4 p-0 font-semibold md:justify-end"
								>
									<div
										class="flex w-full items-center justify-start gap-2 p-0 font-semibold md:justify-end"
									>
										<button
											onclick={() => (params.page = Math.max(1, (params.page || 1) - 1))}
											class="flex h-10 w-10 shrink-0 items-center justify-center rounded border-none bg-slate-500/25 outline-none transition-all hover:bg-slate-500/50 focus:bg-slate-500/50 md:h-8 md:w-8"
										>
											<Icon ph="arrow-left" />
										</button>

										<button
											onclick={() => {
												if (params.page && max_pages === Number(params.page))
													toast.info($_('globals.max-page-reached'));
												params.page = Math.min(max_pages, Number(params.page) + 1);
											}}
											class="flex h-10 w-10 shrink-0 items-center justify-center rounded border-none bg-slate-500/25 outline-none transition-all hover:bg-slate-500/50 focus:bg-slate-500/50 md:h-8 md:w-8"
										>
											<Icon ph="arrow-right" />
										</button>
									</div>
									<div
										class="flex w-full items-center justify-end gap-2 p-0 font-semibold md:max-w-max"
									>
										<small>
											{$_('globals.total')}
											{$_('menu.tags')}
										</small>
										<small>:</small><small
											class="flex aspect-square h-8 min-w-8 shrink-0 items-center justify-center rounded bg-slate-500/15 p-2"
											>{data.countTag}</small
										>
									</div>
								</div>
							</Card>
						</div>
					</div>
				</Card>
			</div>
		{/if}
	</div>
</div>
